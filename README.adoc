= devops-stack-module-cluster-aks

A https://devops-stack.io[DevOps Stack] module to deploy a Kubernetes cluster on Azure AKS.

This module uses the Terraform https://registry.terraform.io/modules/terraform-azurerm/aks/azurerm/latest[module "aks" by Azure] to manage the cluster itself. This module was created in order to also manage other resources required by the DevOps Stack, such as the DNS records, resource group and subnet specific to the cluster created (these resources are helpful for the blue/green upgrading strategy). The module also provides the necessary outputs to be used by the other DevOps Stack modules.

By default, this module creates the AKS control plane and a default node pool composed of 3 nodes of the type `Standard_D2s_v3`. If no version is specified, the AKS cluster and node pool will be created with the latest available version.

[NOTE]
====
The variable `kubernetes_version` sets the version of the AKS control plane while the `orchestrator_version` variable sets the version of the default node pool.

The `node_pools` variable allows you to define the extra node pools you want deployed besides the default one. For each extra node pool you can also define the version of Kubernetes to use with the `orchestrator_version` variable.

Note that the versions of the node pools cannot be higher than the control plane.
====

== Usage

This module can be used with the following declaration:

[source,terraform]
----
module "aks" {
  source = "git::https://github.com/camptocamp/devops-stack-module-cluster-aks.git?ref=<RELEASE>"

  cluster_name         = local.cluster_name
  base_domain          = local.base_domain
  location             = resource.azurerm_resource_group.main.location
  resource_group_name  = resource.azurerm_resource_group.main.name
  virtual_network_name = resource.azurerm_virtual_network.this.name
  cluster_subnet       = local.cluster_subnet

  kubernetes_version        = local.kubernetes_version
  sku_tier                  = local.sku_tier
 
  rbac_aad_admin_group_object_ids = [
    ENTRA_ID_GROUP_UUID,
  ]

  depends_on = [resource.azurerm_resource_group.main]
----

Multiple node pools can be defined with the `node_pools` variable:

[source,terraform]
----
module "aks" {
  source = "git::https://github.com/camptocamp/devops-stack-module-cluster-aks.git?ref=<RELEASE>"

  cluster_name         = local.cluster_name
  base_domain          = local.base_domain
  location             = resource.azurerm_resource_group.main.location
  resource_group_name  = resource.azurerm_resource_group.main.name
  virtual_network_name = resource.azurerm_virtual_network.this.name
  cluster_subnet       = local.cluster_subnet

  kubernetes_version        = local.kubernetes_version
  sku_tier                  = local.sku_tier

  rbac_aad_admin_group_object_ids = [
    ENTRA_ID_GROUP_UUID,
  ]

  # Extra node pools
  node_pools = {
    extra = {
      vm_size = "Standard_D2s_v3"
      node_count = 2
    },
  }

  depends_on = [resource.azurerm_resource_group.main]
}

----

=== Upgrading the Kubernetes cluster

From our experience, usually, enabling the auto-upgrades is a good practice, but up to a point. We recommend enabling the auto-upgrades for the control plane and the node pools, but only for the patch versions. This will ensure that the cluster is always up to date with the latest security patches, but will not upgrade the cluster to a newer minor version, which could potentially break your applications.

To upgrade between minor versions, you are required first yup upgrade the control plane and then the node pools. This is because the node pools cannot be of a higher version than the control plane.

[WARNING]
====
If using the `orchestrator_version` variable for the default or extra node pools, unfortunately, for reasons that escape our comprehension, the upgrade of the control plane through the Terraform code will not work. You would have to manually upgrade the control plane through the Azure portal.

This is why we recommend leaving the `orchestrator_version` variables as `null` and follow the procedure below.
====

1. Ensure that the `orchestrator_version` is not set in any part of your code.

2. Go to the Azure portal and select your cluster. Then on the overview tab, click on the version of the control plane ans you should see a page like below. Click on _Upgrade version_.
+
image::https://raw.githubusercontent.com/camptocamp/devops-stack-module-cluster-aks/main/docs/modules/ROOT/assets/images/upgrade_version_select.png[link=https://raw.githubusercontent.com/camptocamp/devops-stack-module-cluster-aks/main/docs/modules/ROOT/assets/images/upgrade_version_select.png,window=_blank]

3. Afterwards, on the next screen, select the next minor version, make sure you've selected to upgrade the control plane and all the node pools, then start.
+
image:https://raw.githubusercontent.com/camptocamp/devops-stack-module-cluster-aks/main/docs/modules/ROOT/assets/images/upgrade_version_select_all_node_pools.png[link=https://raw.githubusercontent.com/camptocamp/devops-stack-module-applicationset/main/docs/modules/ROOT/assets/images/upgrade_version_select_all_node_pools.png,window=_blank]

4. Wait for all the components to finish the upgrade. Then, you can set the `kubernetes_version` variable to the minor version which you've just upgraded to and apply the Terraform code. This will reconcile the Terraform state with the actual state of the cluster.

=== Automatic cluster upgrades

You can enable automatic upgrades of the control plane and node pools by setting the `automatic_channel_upgrade` variable to a desired value. This will automatically upgrade the control plane and node pools to the latest available version given the constraints you defined in said variable. You can also specify the `maintenance_window` variable to set a maintenance window for the upgrades.

An example of this settings is as follows:

[source,terraform]
----
  automatic_channel_upgrade = "patch"
  maintenance_window = {
    allowed = [
      {
        day   = "Sunday",
        hours = [22, 23]
      },
    ]
    not_allowed = []
  }
----

You can also set the `node_os_channel_upgrade` variable and `maintenance_window_node_os` variables to upgrade the Kubernetes Cluster Nodes' OS Image.

== Technical Reference

// BEGIN_TF_DOCS
// END_TF_DOCS

=== Reference in table format 

.Show tables
[%collapsible]
====
// BEGIN_TF_TABLES
// END_TF_TABLES
====
